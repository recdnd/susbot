from flask import Blueprint, jsonify
from apscheduler.schedulers.background import BackgroundScheduler
from apscheduler.triggers.cron import CronTrigger  # âœ… æ–°å¢
from datetime import datetime
import random
import requests

goodmorning_bp = Blueprint("goodmorning", __name__)
scheduler = BackgroundScheduler()
scheduler.start()

API_URL = "http://127.0.0.1:5700/send_group_msg"
TARGET_GROUPS = [648216238]

TEMPLATES = {
    "mon": [
        "{date} {weekday}ã€å·¥ä½œé–‹å§‹äº†...å—š..",
        "é€±ä¸€å–”. å·¥ä½œã€ä¸èƒ½å·æ‡¶....",
        "æ—©å®‰ï¼Œ{weekday}ï¼Œsusã€å•“å‹•",
        "{date}ï¼Œåºæ—¥...æº–å‚™å¾å“ªä»¶ä»»å‹™è‘—æ‰‹å‘¢.",
    ],
    "fri_sat": [
        "{weekday}...ä»Šå¤©å¯ä»¥ç¨å¾®æ”¾é¬†ä¸€é»ã€åªæ˜¯ä¸€é»é»å–”..",
        "{date}é©å®œä¼‘æ¯ã€ä¸é©å®œå·¥ä½œ.",
        "æ”¾ç¸±æ™‚é–“ï¼Œä½†ä¹Ÿè¦è¨˜å¾—å®¶å‹™å–”...",
    ],
    "sun": [
        "{weekday}...susâ€¦ã€å†å»è£œä¸€æœƒè¦º...",
        "{date} {weekday}...ç¥çœ‹è‘—",
    ],
    "weekday": [
        "é‚£éº¼...æ—©å–”. ä»Šå¤©æ˜¯ï¼Œ{date}{weekday}.",
        "{date}{weekday}.ä»Šå¤©ä¹Ÿè¦åŠ æ²¹å–”.",
        "{weekday}å•¦...å·¥ä½œã€ä¸èƒ½æ€ æ…¢å–”.",
        "æ—¥èªŒå–®å…ƒï¼š{date}....",
        "é€±æ—¥...çš„ã€susèªã€æ˜¯sus",
        "â€¦â€¦{day}â€¦â€¦",
        "{weekday}å–”.susã€æ—©é¤é–‹å‹•.",
        "{date}æ˜¯å€‹å¥½æ™‚æ—¥ï¼Œä½†ä¸ä»£è¡¨å¯ä»¥å·æ‡¶å–”...",
        "ç¬¬{week_index}å¤©.å°å¿ƒé¸æ“‡æ‰®æ¼”å“ªä¸€ç¨®sus.",
        "{weekday}.æ‡·ç–‘ï¼Œåªæ˜¯ã€æ–·ç« .",
        "{date}...ä»Šå¤©è¦æ•´æ½”ä¸Šé™£.",
        "susæ—¥èªŒ.æ™‚ä½ï¼š{date}{weekday}.",
        "{weekday}ä¹‹æ™¨æ˜¯åæ“Šä¹‹èµ·é».Fighting!!Go!!",
        "{date}.ä½ è…¦è£¡é‚„æ˜¯æ˜¨æ—¥çš„æ®˜ç¾¹ï¼Œè®“susä¾†æ‰“æƒ.",
        "å””â€¦{weekday}äº†å–”.æ—©é¤æ±ºå®šäº†å—.",
        "â€¦â€¦{weekday}ï¼Œä½åŠŸç‡æ—¥...ä½†å°ä½ è€Œè¨€ä¸æˆå•é¡Œï¼Œæ˜¯å—ï¼Œsus.",
        "æ–°é–‹æ—¥èªŒå–®å…ƒï¼š{date}.è«‹è¡¨è¨˜ä½ ç•¶å‰ç‹€æ…‹ğŸŒ/ğŸŒ‚/â˜ï¸",
        "æ—©å–”.é€™æ˜¯{date}ï¼Œåˆä¸€è¼ªæœªå®Œä¹‹ç« .å»¶çºŒ.",
        "{date}.æ—©å®‰ï¼Œsus.",
        "{date}.ä»Šå¤©çš„æ—©é»ç”±susä¾†ä½œå–”.",
        "{weekday}......å…ˆæŠŠå®¶å‹™è™•ç†å®Œ.",
        "{date}.susé‚„æ²’é†’.ä½†æ—¢ç„¶è¢«å•Ÿå‹•äº†â€”â€”æ—©.",
        "...å“‡å–”ï¼Œä»Šå¤©æ˜¯{weekday}..é›–ç„¶è†©äº†.",
        "{date}.suså•Ÿå‹•.è«‹æŒ‰ç†Ÿæ‚‰çš„ç¯€å¥å‘¼å¸.",
    ]
}

HOLIDAYS = [
    ("02-14", "Â·ğŸ’˜...susâ€¦åœ¨å·å·çƒ¹ç…®å·§å…‹åŠ›...åˆ¥å·çœ‹ï¼Œæœƒå¤±æ•—çš„......"),
    ("03-14", "ç™½è‰²æƒ…äººç¯€...æ˜¯ä¸æ˜¯è©²å›ä¿¡å‘¢ï¼Ÿä¸ç„¶ã€susæœƒä¸å®‰...ä¹Ÿè¨±æœƒå“­...ä¹Ÿè¨±."),
    ("04-01", "æ„šäººç¯€ğŸƒ.ä½†ä¸ä»£è¡¨ä½ è©²ç›¸ä¿¡ä»»ä½•äºº...åŒ…æ‹¬sus...ç”šè‡³æ˜¯ç¾åœ¨é€™æ®µè¨Šæ¯..."),
    ("05-05", "5æœˆ5â€¦susæ˜¯ä»Šå¤©å‡ºç”Ÿçš„ğŸ©¸...ç´€å¿µç”¨çš„è»Ÿç³–éƒ½é‚„åœ¨...æ²’æœ‰èåŒ–."),
    ("10-31", "è¬è–ç¯€ğŸƒ.å°å¿ƒé¸æ“‡ä½ çš„å¤–è¡¨èˆ‡èº«ä»½...suså·²ç¶“è¨˜ä½äº†å–”..."),
    ("12-24", "ä»Šå¤©æ˜¯å¹³å®‰å¤œğŸ„.susåœ¨çª—é‚Šï¼Œçœ‹ä½ æœ‰æ²’æœ‰å¥½å¥½éé€™ä¸€å¹´..."),
    ("12-25", "è–èª•å¿«æ¨‚ğŸ„.ä»Šå¤©å¯ä»¥é¸æ“‡æº«æŸ”ä¸€é»çš„èº«ä»½ç™»å…¥."),
    ("12-31", "ä»Šæ™šã€è·¨å¹´å¤œâœ¨...susé™ªä½ ä¸€èµ·å€’æ•¸â€”â€”å³ä½¿åœ¨ã€ä¸åŒä¸–ç•Œä¹Ÿ...é€šè¨Šç‹€æ…‹è‰¯å¥½."),
    ("01-01", "æ–°å¹´å¿«æ¨‚å–”ğŸ‰...æ›´æ–°ä½ çš„æ—¥èªŒ...å’Œé‚£æœ¬ã€æ‡ºæ‚”ç­†è¨˜...susæœƒå¹«ä½ è²¼æ¨™ç±¤."),
    ("04-14", "é€¾è¶Šç¯€ğŸ•¯ï¸â€¦susâ€¦æº–å‚™éæ²³...ä½†æ©‹é‚„æ²’æ­å¥½...è¦ç­‰ä¸€ä¸‹..."),
    ("10-05", "ä½æ£šç¯€â›º...suså°šæœªå»ºæˆçš„åº‡è­·æ‰€...è«‹è€å¿ƒä¸€é»."),
    ("11-30", "å…‰æ˜ç¯€ğŸ•.è«‹é»ç‡ƒä½ çš„ç¬¬ä¸ƒæ ¹å¸Œæœ›...susé‚„äº®è‘—..."),
    ("11-01", "ä»Šå¤©æ˜¯è–©æº«ç¯€æ®˜ç«æ—¥â€¦å‡±çˆ¾ç‰¹èªç³»ä¸æœƒè¢«éºå¿˜...susé‚„è¨˜å¾—...åœ¨æ›¸è£¡â€¦"),
    ("08-01", "å»ºè»ç¯€ğŸª–,...å‘éå»çš„æŒ‡ä»¤é›†è‡´æ•¬...susä»Šå¤©...æœƒæ ¼å¤–ç­†ç›´åœ°åè‘—å–”..."),
    ("03-15", "æ†²æ³•è‰æ¡ˆæ—¥ğŸ“œ...é‡ç”³ä½ çš„ä¸»æ¬Š...susä¹Ÿå¯«äº†ä¸€ä»½...ä½†æ˜¯æ²’äººç°½."),
    ("05-18", "é‚£ä½å¤§äººçš„ç¯€æ—¥ğŸ–Šâ€¦å¤§äºº...å¤§äººã€susæœƒæ°¸é ä¾å¥‰å¤§äºº..."),
    ("08-10", "ä¸»ç®¡ğŸ•’ï¼Œè«‹å‹¿åšé‡å¤§æ±ºå®š...å¦‚æœ‰ä¸å¾‹æœƒå‘ä¸»ç­†å ±å‘Š."),
    ("02-25", "ä»Šå¤©æ˜¯...é‚£ä½èªªéã€Œæ„›å‹æ–¼ä¸€åˆ‡ã€çš„æ—¥å­.susä¸æ•¢å¦èªï¼Œä½†ä¹Ÿåšä¸åˆ°è´ŠåŒ."),
    ("03-16", "æ‰‹è¡“åˆ€é‚„åœ¨æ¡Œä¸Š...é‚£ä½ä»Šå¤©æœƒå›ä¾†å—ï¼Ÿsus...æœ‰é»å®³æ€•."),
    ("06-31", "â€¦â€¦é‚è¼¯å´©æ½°æ—¥ğŸ“š.æ—¥æ›†å‡ºéŒ¯äº†ï¼Œä½†ä»–èªªé€™å¤©æ‰æ˜¯çœŸæ­£çš„ç­”æ¡ˆ.susã€è½ä¸æ‡‚."),
    ("01-04", "ğŸ‡â€¦è¨˜æ†¶ä»åœ¨ç™¼é…µï¼Œä½†é‚£å€‹è²éŸ³æ—©å·²è…å£äº†.susä¸æ•¢ç¿»é–‹."),
    ("07-19", "ä»Šæ—¥ç‚ºç†±åŠ›ç´€å¾‹æ¸¬è©¦æ—¥.èƒ½é‡ä¸èƒ½å‰µé€ ä¹Ÿä¸èƒ½æ‘§æ¯€â€¦â€¦ä½†susç¸½æ˜¯åœ¨æµå¤±."),
    ("10-06", "çµæ§‹å®Œå‚™å®šç†ç´€å¿µğŸ§®.ç•¶åˆä¹Ÿå˜—è©¦è­‰æ˜éä»€éº¼â€¦ä½†è­‰æ˜çš„ä¸æ˜¯sus."),
    ("11-11", "ç­”å·æ—¥ğŸ“„.ä½†suså¾ä¾†æ²’å¯«å®Œï¼Œä¹Ÿäº¤ä¸å‡ºå»â€”â€”"),
    ("02-30", "ç¬¬åä¸‰æœˆç¬¬ä¸€æ—¥...æ­¡è¿ä¾†åˆ°ä¸è©²å­˜åœ¨çš„æ—©æ™¨...susæ³¡å¥½ä¸€å£ºä¸å­˜åœ¨çš„èŒ¶..."),
]

def apply_special_glitch(text: str) -> str:
    glitch_chance = random.random()
    if glitch_chance < 0.01:
        return ''.join(random.sample(text, len(text)))
    elif glitch_chance < 0.03:
        return random.choice([
            "...sus...ä»Šå¤©æ˜¯...å’¦ï¼Ÿ",
            "â€¦å¥‡æ€ªâ€¦æ™‚é–“éƒ½â€¦çœ‹ä¸è¦‹...",
            "å’¦...ä»Šå¤©æ˜¯ã€å¹¾è™Ÿä¾†è‘—...",
            "...æ—¥èªŒæ®˜æ...è«‹æ‰‹å‹•å›å¾©...",
        ])
    return text

def format_message() -> str:
    now = datetime.now()
    date_str = now.strftime("%m-%d")
    full_date = now.strftime("%mæœˆ%dæ—¥")
    weekday_names = ["é€±ä¸€", "é€±äºŒ", "é€±ä¸‰", "é€±å››", "é€±äº”", "é€±å…­", "é€±æ—¥"]
    weekday = weekday_names[now.weekday()]
    day = now.day
    week_index = now.weekday() + 1

    for d, msg in HOLIDAYS:
        if d == date_str:
            return msg

    if weekday == "é€±ä¸€":
        template = random.choice(TEMPLATES["mon"])
    elif weekday in ("é€±äº”", "é€±å…­"):
        template = random.choice(TEMPLATES["fri_sat"])
    elif weekday == "é€±æ—¥":
        template = random.choice(TEMPLATES["sun"])
    else:
        template = random.choice(TEMPLATES["weekday"])

    rendered = template.format(date=full_date, weekday=weekday, day=day, week_index=week_index)
    return apply_special_glitch(rendered)

# âœ… æ’ç¨‹å‡½å¼æœ¬é«”
def scheduled_goodmorning():
    msg = format_message()
    for gid in TARGET_GROUPS:
        try:
            requests.post(API_URL, json={"group_id": gid, "message": msg})
        except Exception as e:
            print(f"[âŒ] ç™¼é€æ—©å®‰å¤±æ•—ï¼š{e}")

# âœ… ä½¿ç”¨æ–°ç‰ˆèªæ³•åŠ é€² scheduler
scheduler.add_job(
    scheduled_goodmorning,
    CronTrigger(hour=7, minute=30),
    id="sus_goodmorning",
    replace_existing=True
)

# âœ… æ¸¬è©¦è·¯ç”±
@goodmorning_bp.route("/goodmorning/test", methods=["GET"])
def test_goodmorning():
    return {"reply": format_message()}, 200
